<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>UNISWOP â€¢ Sepolia</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
:root{--bg:#0d111c;--panel:#151b2c;--b:#202a40;--txt:#f5f6fa;--sub:#9ca3af;--g1:#ff4ecd;--g2:#ff007a}
*{box-sizing:border-box} body{margin:0;background:radial-gradient(circle at 10% -10%,#1a2033,#0d111c);
font-family:Inter,system-ui,sans-serif;color:var(--txt);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.app{width:min(460px,95vw)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.brand{display:flex;align-items:center;gap:8px;font-weight:800;font-size:20px}
.brand span{background:linear-gradient(90deg,var(--g1),var(--g2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;color:#fff;background:linear-gradient(90deg,var(--g1),var(--g2));cursor:pointer}
.card{background:#0f1626;border:1px solid var(--b);border-radius:16px;padding:16px}
.box{background:#0c111b;border:1px solid var(--b);border-radius:14px;padding:14px;display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.box input{width:55%;background:transparent;border:0;color:#fff;text-align:right;font-size:20px;font-weight:800;outline:none}
select{background:transparent;border:0;color:#fff;font-size:16px;font-weight:700;outline:none}
.center{text-align:center;margin:8px 0}
.flip{width:34px;height:34px;border-radius:50%;border:1px solid var(--b);background:#121a2a;color:#fff;cursor:pointer}
.small{font-size:12px;color:var(--sub)}
.row{display:flex;gap:8px;align-items:center;background:#0c111b;border:1px solid var(--b);border-radius:12px;padding:8px;margin:6px 0}
.row input{flex:1;background:transparent;border:0;color:#fff}
.swap{width:100%;margin-top:10px}
pre{margin-top:10px;background:#0c111b;border:1px solid var(--b);border-radius:12px;padding:10px;font-size:12px;color:#b5c8ff;max-height:220px;overflow:auto}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">ðŸ¦„ <span>UNISWOP</span></div>
    <button id="btnConnect" class="btn">Connect</button>
  </div>

  <div class="card">
    <div class="box">
      <select id="tokenA"></select>
      <input id="amtA" placeholder="0.0" inputmode="decimal" />
    </div>
    <div class="small" id="balA">Balance: -</div>

    <div class="center"><button id="flip" class="flip">â‡…</button></div>

    <div class="box">
      <select id="tokenB"></select>
      <input id="amtB" placeholder="0.0" disabled />
    </div>
    <div class="small" id="balB">Balance: -</div>

    <div class="row">
      <input id="slippage" value="0.5"/><span class="small">% slippage</span>
      <input id="deadline" value="20"/><span class="small">min</span>
    </div>

    <button id="btnSwap" class="btn swap">Swap</button>
    <div class="small" id="rate">Estimasi: -</div>
    <pre id="log">log siap...</pre>
  </div>
</div>

<script>
/* ===== Config (ringkas) ===== */
const CHAIN = { id:11155111, hex:"0xaa36a7", name:"Sepolia", explorer:"https://sepolia.etherscan.io" };
const ROUTER = "0x eE567Fe1712Faf6149d80dA1E6934E354124CfE3".replace(" ",""); // rapikan spasi accidental
const FACTORY= "0xF62c03E08ada871A0bEb309762E260a7a6a880E6"; // tidak dipakai berat-berat di UI ringkas

const TOKENS = [
  {sym:"ETH",  addr:"ETH_NATIVE", dec:18},
  {sym:"WETH", addr:"0xfff9976782d46cc05630d1f6ebab18b2324d6b14", dec:18},
  {sym:"USDC", addr:"0x1c7d4b196cb0c7b01d743fbc6116a902379c7238", dec:6},
];
const WETH_ADDR = TOKENS[1].addr;

const ERC20 = [
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];
const ROUTER_ABI = [
  "function getAmountsOut(uint256,address[]) view returns (uint256[])",
  "function swapExactTokensForTokens(uint256,uint256,address[],address,uint256) returns (uint256[])",
  "function swapExactETHForTokens(uint256,address[],address,uint256) payable returns (uint256[])",
  "function swapExactTokensForETH(uint256,uint256,address[],address,uint256) returns (uint256[])"
];

const $=id=>document.getElementById(id);
const log=m=>{const el=$("log");el.textContent+=(el.textContent?"\n":"")+m;el.scrollTop=el.scrollHeight;console.log(m)};

let provider, signer, me, balTimer;

/* ===== UI init ===== */
function initUI(){
  ["tokenA","tokenB"].forEach(id=>{
    const el=$(id); el.innerHTML="";
    TOKENS.forEach((t,i)=> el.add(new Option(t.sym,i)));
  });
  $("tokenA").value=1; // WETH
  $("tokenB").value=2; // USDC
}
initUI();

/* ===== Wallet ===== */
async function ensureProvider(){
  if(!window.ethereum) throw new Error("MetaMask belum tersedia");
  if(!provider) provider = new ethers.providers.Web3Provider(window.ethereum, "any");
}
async function connect(){
  try{
    await ensureProvider();
    await provider.send("eth_requestAccounts",[]);
    signer = provider.getSigner(); me = await signer.getAddress();
    const net = await provider.getNetwork();
    if(net.chainId!==CHAIN.id){
      await window.ethereum.request({method:"wallet_switchEthereumChain", params:[{chainId:CHAIN.hex}]});
    }
    $("btnConnect").textContent = me.slice(0,6)+"â€¦"+me.slice(-4);
    log(`âœ… Connected: ${me} (chain ${CHAIN.id})`);
    refreshBalances(); clearInterval(balTimer); balTimer=setInterval(refreshBalances,10000);
    estimate();
  }catch(e){ log("âŒ Connect error: "+(e.message||e)); }
}
$("btnConnect").onclick = connect;

/* ===== Helpers ===== */
function sanitizeNumber(s){
  s = String(s||"").trim().replace(/,/g,"");       // buang koma
  if(!s) return "";                                 // kosong
  if(!/^\d*\.?\d*$/.test(s)) return "";             // hanya digit & titik
  if(s.startsWith(".")) s = "0"+s;                  // ".5" -> "0.5"
  if(s.endsWith("."))  s = s.slice(0,-1);           // "1." -> "1"
  return s;
}
function parseUnitsSafe(s, dec){
  const clean = sanitizeNumber(s);
  if(!clean || isNaN(Number(clean))) throw new Error("invalid decimal value");
  return ethers.utils.parseUnits(clean, dec);
}
function toHuman(bn, dec){ return Number(ethers.utils.formatUnits(bn, dec)); }
function pathOf(a,b){
  const A=TOKENS[+$("tokenA").value], B=TOKENS[+$("tokenB").value];
  const src=(A.addr==="ETH_NATIVE")? WETH_ADDR : A.addr;
  const dst=(B.addr==="ETH_NATIVE")? WETH_ADDR : B.addr;
  return [src,dst];
}

/* ===== Balances ===== */
async function balanceOf(token){
  if(!provider||!me) return "0";
  if(token.addr==="ETH_NATIVE"){
    const v=await provider.getBalance(me);
    return ethers.utils.formatUnits(v, token.dec);
  }
  const c=new ethers.Contract(token.addr, ERC20, provider);
  const v=await c.balanceOf(me);
  return ethers.utils.formatUnits(v, token.dec);
}
async function refreshBalances(){
  try{
    const ta=TOKENS[+$("tokenA").value], tb=TOKENS[+$("tokenB").value];
    const [ba,bb] = await Promise.all([balanceOf(ta), balanceOf(tb)]);
    $("balA").textContent = `Balance: ${(+ba).toFixed(4)} ${ta.sym}`;
    $("balB").textContent = `Balance: ${(+bb).toFixed(4)} ${tb.sym}`;
  }catch{}
}

/* ===== Estimasi ===== */
async function estimate(){
  try{
    if(!provider) return;
    const ta=TOKENS[+$("tokenA").value], tb=TOKENS[+$("tokenB").value];
    const inStr = sanitizeNumber($("amtA").value);
    if(!inStr || +inStr===0 || ta===tb){ $("amtB").value=""; $("rate").textContent="Estimasi: -"; return; }
    const amountIn = parseUnitsSafe(inStr, ta.dec);
    const router = new ethers.Contract(ROUTER, ROUTER_ABI, provider);
    const amounts = await router.getAmountsOut(amountIn, pathOf());
    const out = amounts[amounts.length-1];
    const outHuman = toHuman(out, tb.dec);
    $("amtB").value = tb.dec>6 ? outHuman.toFixed(6) : outHuman.toFixed(tb.dec);
    $("rate").textContent = `1 ${ta.sym} â‰ˆ ${(outHuman/+inStr).toFixed(6)} ${tb.sym}`;
  }catch(e){
    $("amtB").value="";
    $("rate").textContent="Estimasi gagal (no liquidity / path not found)";
  }
}
$("amtA").oninput=()=>{ $("amtA").value=sanitizeNumber($("amtA").value); estimate(); };
["tokenA","tokenB"].forEach(id=>$(id).onchange=()=>{ estimate(); refreshBalances(); });
$("flip").onclick=()=>{
  const a=$("tokenA"), b=$("tokenB"); [a.value,b.value]=[b.value,a.value];
  const x=$("amtA"), y=$("amtB"); [x.value,y.value]=[y.value,x.value];
  estimate(); refreshBalances();
};

/* ===== Approve ===== */
async function ensureAllowance(tokenAddr, needed){
  const erc = new ethers.Contract(tokenAddr, ERC20, signer);
  const cur = await erc.allowance(me, ROUTER);
  if(cur.gte(needed)) return;
  const tx = await erc.approve(ROUTER, needed);
  log(`ðŸ§¾ Approve â†’ ${tx.hash}`); await tx.wait(); log("âœ… Approve success");
}

/* ===== Swap ===== */
$("btnSwap").onclick = async ()=>{
  try{
    await ensureProvider(); if(!signer) await connect();
    const net=await provider.getNetwork(); if(net.chainId!==CHAIN.id) throw new Error(`Switch ke ${CHAIN.name} dulu`);
    const ta=TOKENS[+$("tokenA").value], tb=TOKENS[+$("tokenB").value];
    if(ta.addr===tb.addr) throw new Error("Token input/output tidak boleh sama.");
    const inStr=sanitizeNumber($("amtA").value); if(!inStr || +inStr<=0) throw new Error("Isi jumlah input yang valid.");

    const sl = Math.max(0, Math.min(100, parseFloat(sanitizeNumber($("slippage").value)||"0.5")));
    const dl = Math.max(1, parseInt(sanitizeNumber($("deadline").value)||"20"));
    const amountIn = parseUnitsSafe(inStr, ta.dec);
    const deadlineTs = Math.floor(Date.now()/1000) + dl*60;

    const router = new ethers.Contract(ROUTER, ROUTER_ABI, signer);
    const path = pathOf();
    const amounts = await router.getAmountsOut(amountIn, path);
    const out = amounts[amounts.length-1];
    const amountOutMin = out.mul(10000 - Math.floor(sl*100)).div(10000);

    let tx;
    if(ta.addr==="ETH_NATIVE"){ // swapExactETHForTokens
      tx = await router.swapExactETHForTokens(amountOutMin, path, me, deadlineTs, { value: amountIn, gasLimit: 650000 });
    } else if(tb.addr==="ETH_NATIVE"){ // swapExactTokensForETH
      await ensureAllowance(ta.addr, amountIn);
      tx = await router.swapExactTokensForETH(amountIn, amountOutMin, path, me, deadlineTs, { gasLimit: 650000 });
    } else { // swapExactTokensForTokens
      await ensureAllowance(ta.addr, amountIn);
      tx = await router.swapExactTokensForTokens(amountIn, amountOutMin, path, me, deadlineTs, { gasLimit: 650000 });
    }
    log(`â³ TX: ${tx.hash}`);
    const rc=await tx.wait();
    log(`âœ… Swap success â€¢ Block ${rc.blockNumber} â€¢ ${CHAIN.explorer}/tx/${tx.hash}`);
    refreshBalances(); estimate();
  }catch(e){
    log("âŒ Swap error: "+(e.data?.message || e.reason || e.message || e));
  }
};
</script>
</body>
</html>
